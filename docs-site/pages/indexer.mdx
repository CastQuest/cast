# Indexer

The CASTQUEST Indexer monitors blockchain events in real-time and provides a REST API for querying indexed data.

## Overview

The indexer provides:
- Real-time event monitoring
- Historical data backfill
- PostgreSQL storage
- REST API endpoints
- Support for all 13 contracts

## Installation

```bash
npm install @castquest/indexer
```

## Configuration

Set environment variables:

```bash
# Database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=castquest
DB_USER=postgres
DB_PASSWORD=your_password

# Blockchain
RPC_URL=https://mainnet.infura.io/v3/YOUR_KEY

# Contract Addresses
CAST_ADDRESS=0x...
QUEST_ADDRESS=0x...
MARKETPLACE_ADDRESS=0x...
GOVERNANCE_ADDRESS=0x...

# API Server
PORT=3001
```

## Running the Indexer

```bash
cd packages/indexer
pnpm start
```

The indexer will:
1. Connect to the database
2. Initialize schema if needed
3. Backfill historical events (last 10,000 blocks)
4. Start monitoring new events
5. Start the API server

## Database Schema

### CASTs Table

```sql
CREATE TABLE casts (
  token_id BIGINT PRIMARY KEY,
  creator VARCHAR(42) NOT NULL,
  content_hash TEXT NOT NULL,
  royalty_bps INTEGER NOT NULL,
  block_number INTEGER NOT NULL,
  transaction_hash VARCHAR(66) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_casts_creator ON casts(creator);
CREATE INDEX idx_casts_block ON casts(block_number);
```

### Quests Table

```sql
CREATE TABLE quests (
  quest_id BIGINT PRIMARY KEY,
  creator VARCHAR(42) NOT NULL,
  title TEXT NOT NULL,
  reward NUMERIC NOT NULL,
  block_number INTEGER NOT NULL,
  transaction_hash VARCHAR(66) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_quests_creator ON quests(creator);
```

### Marketplace Listings Table

```sql
CREATE TABLE marketplace_listings (
  listing_id BIGINT PRIMARY KEY,
  seller VARCHAR(42) NOT NULL,
  nft_contract VARCHAR(42) NOT NULL,
  token_id BIGINT NOT NULL,
  price NUMERIC NOT NULL,
  is_active BOOLEAN DEFAULT true,
  block_number INTEGER NOT NULL,
  transaction_hash VARCHAR(66) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_listings_seller ON marketplace_listings(seller);
CREATE INDEX idx_listings_active ON marketplace_listings(is_active);
```

### Proposals Table

```sql
CREATE TABLE proposals (
  proposal_id BIGINT PRIMARY KEY,
  proposer VARCHAR(42) NOT NULL,
  title TEXT NOT NULL,
  block_number INTEGER NOT NULL,
  transaction_hash VARCHAR(66) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_proposals_proposer ON proposals(proposer);
```

## REST API

### Health Check

```bash
GET /health
```

Returns server status.

**Response:**
```json
{
  "status": "ok",
  "timestamp": "2024-01-17T00:00:00.000Z"
}
```

### Get CASTs by Creator

```bash
GET /api/casts?creator=0x123...
```

**Response:**
```json
[
  {
    "token_id": "1",
    "creator": "0x123...",
    "content_hash": "QmIPFS...",
    "royalty_bps": 1000,
    "block_number": 123456,
    "transaction_hash": "0xabc...",
    "created_at": "2024-01-17T00:00:00.000Z"
  }
]
```

### Get Quests by Creator

```bash
GET /api/quests?creator=0x123...
```

**Response:**
```json
[
  {
    "quest_id": "1",
    "creator": "0x123...",
    "title": "Complete Tutorial",
    "reward": "100000000000000000",
    "block_number": 123456,
    "transaction_hash": "0xabc...",
    "created_at": "2024-01-17T00:00:00.000Z"
  }
]
```

### Get Active Marketplace Listings

```bash
GET /api/marketplace/listings
```

**Response:**
```json
[
  {
    "listing_id": "1",
    "seller": "0x123...",
    "nft_contract": "0xabc...",
    "token_id": "1",
    "price": "1000000000000000000",
    "is_active": true,
    "block_number": 123456,
    "transaction_hash": "0xdef...",
    "created_at": "2024-01-17T00:00:00.000Z"
  }
]
```

### Get Governance Proposals

```bash
GET /api/governance/proposals
```

**Response:**
```json
[
  {
    "proposal_id": "1",
    "proposer": "0x123...",
    "title": "Increase Platform Fee",
    "block_number": 123456,
    "transaction_hash": "0xabc...",
    "created_at": "2024-01-17T00:00:00.000Z"
  }
]
```

### Get Platform Stats

```bash
GET /api/stats
```

**Response:**
```json
{
  "totalCasts": 10000,
  "totalQuests": 500,
  "totalListings": 250,
  "totalProposals": 50
}
```

## Architecture

```
┌─────────────┐
│ Blockchain  │
│   (EVM)     │
└──────┬──────┘
       │ Events
       ▼
┌─────────────┐
│   Indexer   │
│  (Node.js)  │
└──────┬──────┘
       │
       ├──────► PostgreSQL
       │
       └──────► REST API
                    │
                    ▼
               ┌─────────┐
               │ Clients │
               └─────────┘
```

## Event Processing

### CAST Events

Monitored events:
- `CastMinted(uint256 tokenId, address creator, string contentHash, uint96 royaltyBps)`
- `CastUpdated(uint256 tokenId, string newContentHash)`
- `RoyaltyUpdated(uint256 tokenId, uint96 newRoyaltyBps)`

### Quest Events

- `QuestCreated(uint256 questId, address creator, string title, uint256 reward)`
- `QuestJoined(uint256 questId, address participant)`
- `QuestCompleted(uint256 questId, address winner, uint256 reward)`

### Marketplace Events

- `Listed(uint256 listingId, address seller, address nftContract, uint256 tokenId, uint256 price)`
- `Sold(uint256 listingId, address buyer, uint256 price)`
- `ListingCancelled(uint256 listingId)`

### Governance Events

- `ProposalCreated(uint256 proposalId, address proposer, string title)`
- `VoteCast(uint256 proposalId, address voter, uint8 support, uint256 weight)`
- `ProposalExecuted(uint256 proposalId)`

## Performance

- **Throughput**: 100+ events/second
- **Latency**: <1 second from chain to API
- **Storage**: Efficient indexing with proper indexes
- **Scalability**: Horizontal scaling supported

## Monitoring

Monitor indexer health:

```bash
curl http://localhost:3001/health
```

Check logs:

```bash
tail -f indexer.log
```

## Backup & Recovery

### Database Backup

```bash
pg_dump castquest > backup.sql
```

### Restore from Backup

```bash
psql castquest < backup.sql
```

### Reindex from Scratch

```bash
# Drop and recreate database
dropdb castquest
createdb castquest

# Restart indexer (will reinitialize)
pnpm start
```

## Advanced Configuration

### Custom Block Range

```typescript
await indexer.indexHistoricalEvents(startBlock, endBlock);
```

### Multiple Chains

Run separate indexer instances for each chain:

```bash
# Terminal 1: Mainnet
RPC_URL=$MAINNET_RPC DB_NAME=castquest_mainnet pnpm start

# Terminal 2: Base
RPC_URL=$BASE_RPC DB_NAME=castquest_base pnpm start
```

## Troubleshooting

### Indexer Stuck

Restart the indexer:

```bash
pkill -f indexer
pnpm start
```

### Missing Events

Check block range:

```sql
SELECT MIN(block_number), MAX(block_number) FROM casts;
```

Reindex if needed:

```bash
pnpm start -- --from-block 0
```

### Database Connection Error

Check PostgreSQL status:

```bash
pg_isready -h localhost -p 5432
```

## Source Code

[View on GitHub](https://github.com/castquest/cast/tree/main/packages/indexer)
